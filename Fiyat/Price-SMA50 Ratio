//@version=5
indicator("Fiyat/SMA50 Oranı", shorttitle="P/SMA50", overlay=false)

// Kullanıcı ayarları
sma_period = input.int(50, title="SMA Periyodu", minval=1, maxval=200)
upper_line = input.float(1.05, title="Üst Referans Çizgisi", minval=0.5, maxval=2.0, step=0.01)
lower_line = input.float(0.95, title="Alt Referans Çizgisi", minval=0.5, maxval=2.0, step=0.01)

// Çizgi stilleri
upper_line_style = input.string("Kesikli", title="Üst Çizgi Stili", options=["Düz", "Kesikli", "Noktalı"])
lower_line_style = input.string("Kesikli", title="Alt Çizgi Stili", options=["Düz", "Kesikli", "Noktalı"])

// Renkler
ratio_color = input.color(color.blue, title="Oran Çizgisi Rengi")
upper_color = input.color(color.red, title="Üst Çizgi Rengi")
lower_color = input.color(color.green, title="Alt Çizgi Rengi")
middle_color = input.color(color.gray, title="Orta Çizgi Rengi")

// Hesaplamalar
sma_50 = ta.sma(close, sma_period)
price_sma_ratio = close / sma_50

// Çizgi stilini belirleme fonksiyonu
get_hline_style(style_name) =>
    switch style_name
        "Düz" => hline.style_solid
        "Kesikli" => hline.style_dashed
        "Noktalı" => hline.style_dotted
        => hline.style_solid

// Ana oran çizgisini çiz
plot(price_sma_ratio, title="Fiyat/SMA Oranı", color=ratio_color, linewidth=2)

// Referans çizgileri
hline(1.0, title="Orta Çizgi (1.0)", color=middle_color, linestyle=hline.style_solid, linewidth=1)
hline(upper_line, title="Üst Referans", color=upper_color, linestyle=get_hline_style(upper_line_style), linewidth=2)
hline(lower_line, title="Alt Referans", color=lower_color, linestyle=get_hline_style(lower_line_style), linewidth=2)

// Arka plan renklendirme (opsiyonel)
show_bgcolor_upper = input.bool(false, title="Üst Bölge Arka Plan Rengi")
show_bgcolor_lower = input.bool(false, title="Alt Bölge Arka Plan Rengi")

bgcolor(show_bgcolor_upper and price_sma_ratio > upper_line ? color.new(color.red, 95) : na)
bgcolor(show_bgcolor_lower and price_sma_ratio < lower_line ? color.new(color.green, 95) : na)

// Bilgi tablosu (opsiyonel)
show_table = input.bool(true, title="Bilgi Tablosunu Göster")

if show_table and barstate.islast
    var table info_table = table.new(position.top_right, 2, 4, bgcolor=color.white, border_width=1)
    
    table.cell(info_table, 0, 0, "Metrik", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 0, "Değer", text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 1, "Mevcut Oran", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 1, str.tostring(price_sma_ratio, "#.####"), text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 2, "SMA" + str.tostring(sma_period), text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 2, str.tostring(sma_50, "#.##"), text_color=color.black, text_size=size.small)
    
    table.cell(info_table, 0, 3, "Mevcut Fiyat", text_color=color.black, text_size=size.small)
    table.cell(info_table, 1, 3, str.tostring(close, "#.##"), text_color=color.black, text_size=size.small)

// Alarm koşulları
alertcondition(ta.crossover(price_sma_ratio, upper_line), title="Üst Çizgiyi Yukarı Kesti", message="Fiyat/SMA oranı üst referans çizgisini yukarı doğru kesti")
alertcondition(ta.crossunder(price_sma_ratio, upper_line), title="Üst Çizgiyi Aşağı Kesti", message="Fiyat/SMA oranı üst referans çizgisini aşağı doğru kesti")
alertcondition(ta.crossover(price_sma_ratio, lower_line), title="Alt Çizgiyi Yukarı Kesti", message="Fiyat/SMA oranı alt referans çizgisini yukarı doğru kesti")
alertcondition(ta.crossunder(price_sma_ratio, lower_line), title="Alt Çizgiyi Aşağı Kesti", message="Fiyat/SMA oranı alt referans çizgisini aşağı doğru kesti")
